# Duty SCDP bot

Бот тегает ответственного дежурного в Loop чате каждый день в 08:50 (или в другое время из конфигурации), пока тот не ответит `@take`.

## Возможности

- чтение расписания дежурств и списка сотрудников из `config.toml` (значения можно переопределять переменными окружения `LOOP_*`);
- при наличии секции `oncall` в `config.toml` бот читает текущих дежурных из Grafana OnCall;
- ежедневное отправление первого сообщения дежурному в общий чат Loop;
- повтор напоминания каждые 15 минут в треде до тех пор, пока дежурный не напишет `@take`;
- обработка входящих сообщений через встроенный HTTP веб‑хук (порт и адрес задаются параметрами запуска);
- отдельный HTTP‑эндпоинт для мгновенного тегания любого контакта из `config.toml`.

## Конфигурация

`config.toml` содержит все настройки. Пример:

```toml
[loop]
token = "123"
admin_group_id = "6f13unqm4tff9moebxes8s4nqo"
server_url = "https://lemanapro.loop.ru"
team = "lemanapro"

[notification]
time = "08:50"
timezone = "Europe/Moscow"
reminder_interval_minutes = 15
weekends_alerts = true

[oncall]
token = "grafana-oncall-token"
base_url = "https://obs-grafana-oncall.example.com/138"
schedule_name = "Support"

[contacts.alice]
ldap = "alice.petrov"
full_name = "Алиса Петрова"

[schedule]
monday = "alice"
```

Полный файл можно посмотреть в репозитории (`config.toml`).

## Запуск

```bash
python -m dutyscdp_bot.main --config config.toml --webhook-port 8080
```

## Настройка Loop

Необходимые переменные окружения (или значения в конфиге):

- `LOOP_TOKEN`
- `LOOP_ADMIN_GROUP_ID`
- `LOOP_SERVER_URL` (по умолчанию `https://lemanapro.loop.ru`)
- `LOOP_TEAM` (по умолчанию `lemanapro`)

Если нужно забирать дежурных из Grafana OnCall, добавьте секцию `[oncall]` в конфиг и задайте:

- `ONCALL_TOKEN`
- `ONCALL_BASE_URL`
- `ONCALL_SCHEDULE_NAME`

Loop должен быть сконфигурирован на отправку webhook-событий (сообщений из группы) на эндпоинт `/` того HTTP сервера, который запускает бот.

### Ручной запуск уведомлений

Чтобы запустить полноценную сессию напоминаний (с повтором каждые 15 минут), отправьте POST‑запрос на `/trigger` с телом вида:

```json
{ "contact": "alice" }
```

`contact` — ключ из секции `[contacts]` в конфиге. В ответ вернётся `{ "status": "ok" }`, если уведомление запущено. Если уже идёт другой сеанс напоминаний или контакт не найден, сервер вернёт ошибку с соответствующим описанием.

Если нужно просто разово тегнуть человека без запуска напоминаний, отправьте POST‑запрос на `/ping` с тем же телом. Эндпоинт вернёт `{ "status": "ok" }` при успешной отправке сообщения или ошибку, если контакт не найден.

Чтобы вручную запустить **полный on-call процесс** (загрузка текущих дежурных из Grafana OnCall, синхронизация группы дежурных в Loop и старт сессии напоминаний), отправьте POST‑запрос на `/duty_oncall` без обязательного тела. Эндпоинт вернёт `{ "status": "ok" }`, если on-call дежурные найдены и процесс успешно запущен. Если дежурные не найдены или уже идёт другая сессия напоминаний, вернётся ошибка.

## Деплой в Kubernetes

Для развёртывания бота в Kubernetes добавлен Helm chart `charts/dutyscdp-bot`. Файл `config.toml` создаётся как `ConfigMap`, поэтому его можно редактировать напрямую в кластере. Подробности и пример установки смотрите в [документации](docs/kubernetes.md).
